<template>
  <scroll-view class="container" scroll-y="true" style="height: 100vh;">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <view class="header card">
      <view class="title">ğŸ”§ API æ¼”ç¤º</view>
      <view class="subtitle">å±•ç¤ºå°ç¨‹åºå¸¸ç”¨ API çš„ä½¿ç”¨æ–¹æ³•</view>
    </view>

    <!-- ç½‘ç»œè¯·æ±‚ API -->
    <view class="section">
      <view class="section-title">ç½‘ç»œè¯·æ±‚</view>
      <demo-section title="HTTP è¯·æ±‚">
        <view class="api-demo">
          <button class="btn-primary" bindtap="testHttpRequest" loading="{{httpLoading}}">
            {{httpLoading ? 'è¯·æ±‚ä¸­...' : 'å‘èµ· HTTP è¯·æ±‚'}}
          </button>
          <view class="result-box" wx:if="{{httpResult}}">
            <view class="result-title">è¯·æ±‚ç»“æœï¼š</view>
            <text class="result-content">{{httpResult}}</text>
          </view>
        </view>
      </demo-section>
    </view>

    <!-- æœ¬åœ°å­˜å‚¨ API -->
    <view class="section">
      <view class="section-title">æœ¬åœ°å­˜å‚¨</view>
      <demo-section title="æ•°æ®å­˜å‚¨">
        <view class="api-demo">
          <view class="input-group">
            <input class="input-field" placeholder="è¯·è¾“å…¥è¦å­˜å‚¨çš„æ•°æ®" value="{{storageData}}" bindinput="onStorageInput" />
          </view>
          <view class="button-group">
            <button class="btn-primary" bindtap="saveToStorage">ä¿å­˜æ•°æ®</button>
            <button class="btn-secondary" bindtap="getFromStorage">è¯»å–æ•°æ®</button>
            <button class="btn-danger" bindtap="clearStorage">æ¸…é™¤æ•°æ®</button>
          </view>
          <view class="result-box" wx:if="{{storageResult}}">
            <view class="result-title">å­˜å‚¨ç»“æœï¼š</view>
            <text class="result-content">{{storageResult}}</text>
          </view>
        </view>
      </demo-section>
    </view>

    <!-- è®¾å¤‡ä¿¡æ¯ API -->
    <view class="section">
      <view class="section-title">è®¾å¤‡ä¿¡æ¯</view>
      <demo-section title="ç³»ç»Ÿä¿¡æ¯">
        <view class="api-demo">
          <button class="btn-primary" bindtap="getSystemInfo">è·å–ç³»ç»Ÿä¿¡æ¯</button>
          <view class="info-list" wx:if="{{systemInfo}}">
            <view class="info-item" wx:for="{{systemInfoList}}" wx:key="key">
              <text class="info-label">{{item.label}}ï¼š</text>
              <text class="info-value">{{item.value}}</text>
            </view>
          </view>
        </view>
      </demo-section>

      <demo-section title="ä½ç½®ä¿¡æ¯">
        <view class="api-demo">
          <button class="btn-primary" bindtap="getLocation" loading="{{locationLoading}}">
            {{locationLoading ? 'å®šä½ä¸­...' : 'è·å–ä½ç½®ä¿¡æ¯'}}
          </button>
          <view class="info-list" wx:if="{{locationInfo}}">
            <view class="info-item">
              <text class="info-label">çº¬åº¦ï¼š</text>
              <text class="info-value">{{locationInfo.latitude}}</text>
            </view>
            <view class="info-item">
              <text class="info-label">ç»åº¦ï¼š</text>
              <text class="info-value">{{locationInfo.longitude}}</text>
            </view>
            <view class="info-item">
              <text class="info-label">ç²¾åº¦ï¼š</text>
              <text class="info-value">{{locationInfo.accuracy}}ç±³</text>
            </view>
          </view>
        </view>
      </demo-section>
    </view>

    <!-- åª’ä½“ API -->
    <view class="section">
      <view class="section-title">åª’ä½“åŠŸèƒ½</view>
      <demo-section title="å›¾ç‰‡é€‰æ‹©">
        <view class="api-demo">
          <button class="btn-primary" bindtap="chooseImage">é€‰æ‹©å›¾ç‰‡</button>
          <view class="image-preview" wx:if="{{selectedImages.length > 0}}">
            <image 
              class="preview-image" 
              wx:for="{{selectedImages}}" 
              wx:key="*this"
              src="{{item}}" 
              mode="aspectFit"
              bindtap="previewImage"
              data-src="{{item}}">
            </image>
          </view>
        </view>
      </demo-section>

      <demo-section title="æ‰«ç åŠŸèƒ½">
        <view class="api-demo">
          <button class="btn-primary" bindtap="scanCode">æ‰«ä¸€æ‰«</button>
          <view class="result-box" wx:if="{{scanResult}}">
            <view class="result-title">æ‰«ç ç»“æœï¼š</view>
            <text class="result-content">{{scanResult}}</text>
          </view>
        </view>
      </demo-section>
    </view>

    <!-- ç•Œé¢åé¦ˆ API -->
    <view class="section">
      <view class="section-title">ç•Œé¢åé¦ˆ</view>
      <demo-section title="æ¶ˆæ¯æç¤º">
        <view class="api-demo">
          <view class="button-group">
            <button class="btn-success" bindtap="showSuccessToast">æˆåŠŸæç¤º</button>
            <button class="btn-warning" bindtap="showErrorToast">é”™è¯¯æç¤º</button>
            <button class="btn-secondary" bindtap="showLoadingToast">åŠ è½½æç¤º</button>
          </view>
        </view>
      </demo-section>

      <demo-section title="éœ‡åŠ¨åé¦ˆ">
        <view class="api-demo">
          <view class="button-group">
            <button class="btn-primary" bindtap="vibrateShort">çŸ­éœ‡åŠ¨</button>
            <button class="btn-primary" bindtap="vibrateLong">é•¿éœ‡åŠ¨</button>
          </view>
        </view>
      </demo-section>
    </view>

    <!-- é¡µé¢è·³è½¬ API -->
    <view class="section">
      <view class="section-title">é¡µé¢è·³è½¬</view>
      <demo-section title="å¯¼èˆªåŠŸèƒ½">
        <view class="api-demo">
          <view class="button-group">
            <button class="btn-primary" bindtap="navigateToHome">è·³è½¬åˆ°é¦–é¡µ</button>
            <button class="btn-secondary" bindtap="navigateBack">è¿”å›ä¸Šé¡µ</button>
            <button class="btn-success" bindtap="redirectToComponents">é‡å®šå‘åˆ°ç»„ä»¶é¡µ</button>
          </view>
        </view>
      </demo-section>
    </view>
  </scroll-view>
</template>

<script>
import { createPage } from '@mpxjs/core'
import mpx from '@mpxjs/core'

createPage({
  data: {
    // ç½‘ç»œè¯·æ±‚
    httpLoading: false,
    httpResult: '',
    
    // æœ¬åœ°å­˜å‚¨
    storageData: '',
    storageResult: '',
    
    // ç³»ç»Ÿä¿¡æ¯
    systemInfo: null,
    systemInfoList: [],
    
    // ä½ç½®ä¿¡æ¯
    locationLoading: false,
    locationInfo: null,
    
    // å›¾ç‰‡
    selectedImages: [],
    
    // æ‰«ç ç»“æœ
    scanResult: ''
  },

  methods: {
    // ç½‘ç»œè¯·æ±‚
    async testHttpRequest() {
      this.httpLoading = true
      this.httpResult = ''
      
      try {
        const result = await mpx.request({
          url: 'https://api.github.com/repos/didi/mpx',
          method: 'GET'
        })
        
        this.httpResult = `è¯·æ±‚æˆåŠŸï¼ä»“åº“åç§°ï¼š${result.data.name}ï¼ŒStaræ•°ï¼š${result.data.stargazers_count}`
      } catch (error) {
        this.httpResult = `è¯·æ±‚å¤±è´¥ï¼š${error.message || 'ç½‘ç»œé”™è¯¯'}`
      } finally {
        this.httpLoading = false
      }
    },

    // æœ¬åœ°å­˜å‚¨
    onStorageInput(e) {
      this.storageData = e.detail.value
    },

    saveToStorage() {
      if (!this.storageData.trim()) {
        mpx.showToast({
          title: 'è¯·è¾“å…¥è¦å­˜å‚¨çš„æ•°æ®',
          icon: 'none'
        })
        return
      }
      
      try {
        mpx.setStorageSync('demo_data', this.storageData)
        this.storageResult = `æ•°æ®ä¿å­˜æˆåŠŸï¼š${this.storageData}`
        mpx.showToast({
          title: 'ä¿å­˜æˆåŠŸ',
          icon: 'success'
        })
      } catch (error) {
        this.storageResult = `ä¿å­˜å¤±è´¥ï¼š${error.message}`
      }
    },

    getFromStorage() {
      try {
        const data = mpx.getStorageSync('demo_data')
        if (data) {
          this.storageResult = `è¯»å–åˆ°çš„æ•°æ®ï¼š${data}`
        } else {
          this.storageResult = 'æš‚æ— å­˜å‚¨æ•°æ®'
        }
      } catch (error) {
        this.storageResult = `è¯»å–å¤±è´¥ï¼š${error.message}`
      }
    },

    clearStorage() {
      try {
        mpx.removeStorageSync('demo_data')
        this.storageResult = 'æ•°æ®å·²æ¸…é™¤'
        this.storageData = ''
        mpx.showToast({
          title: 'æ¸…é™¤æˆåŠŸ',
          icon: 'success'
        })
      } catch (error) {
        this.storageResult = `æ¸…é™¤å¤±è´¥ï¼š${error.message}`
      }
    },

    // ç³»ç»Ÿä¿¡æ¯
    getSystemInfo() {
      mpx.getSystemInfo({
        success: (res) => {
          this.systemInfo = res
          this.systemInfoList = [
            { key: 'platform', label: 'å¹³å°', value: res.platform },
            { key: 'system', label: 'ç³»ç»Ÿ', value: res.system },
            { key: 'version', label: 'ç‰ˆæœ¬', value: res.version },
            { key: 'model', label: 'è®¾å¤‡å‹å·', value: res.model },
            { key: 'pixelRatio', label: 'åƒç´ æ¯”', value: res.pixelRatio },
            { key: 'screenWidth', label: 'å±å¹•å®½åº¦', value: `${res.screenWidth}px` },
            { key: 'screenHeight', label: 'å±å¹•é«˜åº¦', value: `${res.screenHeight}px` }
          ]
        },
        fail: (error) => {
          mpx.showToast({
            title: `è·å–å¤±è´¥ï¼š${error.message}`,
            icon: 'none'
          })
        }
      })
    },

    // ä½ç½®ä¿¡æ¯
    getLocation() {
      this.locationLoading = true
      this.locationInfo = null
      
      mpx.getLocation({
        type: 'gcj02',
        success: (res) => {
          this.locationInfo = {
            latitude: res.latitude.toFixed(6),
            longitude: res.longitude.toFixed(6),
            accuracy: res.accuracy
          }
        },
        fail: (error) => {
          mpx.showToast({
            title: `å®šä½å¤±è´¥ï¼š${error.errMsg}`,
            icon: 'none'
          })
        },
        complete: () => {
          this.locationLoading = false
        }
      })
    },

    // å›¾ç‰‡é€‰æ‹©
    chooseImage() {
      mpx.chooseImage({
        count: 3,
        sizeType: ['original', 'compressed'],
        sourceType: ['album', 'camera'],
        success: (res) => {
          this.selectedImages = res.tempFilePaths
          mpx.showToast({
            title: `é€‰æ‹©äº† ${res.tempFilePaths.length} å¼ å›¾ç‰‡`,
            icon: 'success'
          })
        },
        fail: (error) => {
          mpx.showToast({
            title: `é€‰æ‹©å¤±è´¥ï¼š${error.errMsg}`,
            icon: 'none'
          })
        }
      })
    },

    previewImage(e) {
      const src = e.currentTarget.dataset.src
      mpx.previewImage({
        current: src,
        urls: this.selectedImages
      })
    },

    // æ‰«ç 
    scanCode() {
      mpx.scanCode({
        success: (res) => {
          this.scanResult = `æ‰«ç ç±»å‹ï¼š${res.scanType}ï¼Œç»“æœï¼š${res.result}`
        },
        fail: (error) => {
          this.scanResult = `æ‰«ç å¤±è´¥ï¼š${error.errMsg}`
        }
      })
    },

    // æ¶ˆæ¯æç¤º
    showSuccessToast() {
      mpx.showToast({
        title: 'æ“ä½œæˆåŠŸ',
        icon: 'success',
        duration: 2000
      })
    },

    showErrorToast() {
      mpx.showToast({
        title: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•',
        icon: 'error',
        duration: 2000
      })
    },

    showLoadingToast() {
      mpx.showLoading({
        title: 'åŠ è½½ä¸­...'
      })
      setTimeout(() => {
        mpx.hideLoading()
        mpx.showToast({
          title: 'åŠ è½½å®Œæˆ',
          icon: 'success'
        })
      }, 2000)
    },

    // éœ‡åŠ¨åé¦ˆ
    vibrateShort() {
      mpx.vibrateShort({
        success: () => {
          mpx.showToast({
            title: 'çŸ­éœ‡åŠ¨',
            icon: 'none'
          })
        }
      })
    },

    vibrateLong() {
      mpx.vibrateLong({
        success: () => {
          mpx.showToast({
            title: 'é•¿éœ‡åŠ¨',
            icon: 'none'
          })
        }
      })
    },

    // é¡µé¢è·³è½¬
    navigateToHome() {
      mpx.switchTab({
        url: '/pages/home'
      })
    },

    navigateBack() {
      mpx.navigateBack()
    },

    redirectToComponents() {
      mpx.redirectTo({
        url: '/pages/components'
      })
    }
  }
})
</script>

<style lang="stylus">
.container
  padding 0 20rpx 40rpx
  
.header
  text-align center
  background linear-gradient(135deg, #f093fb 0%, #f5576c 100%)
  color white
  margin-bottom 30rpx
  
  .title
    color white
    font-size 36rpx
    font-weight 600
    
  .subtitle
    color rgba(255, 255, 255, 0.9)
    font-size 26rpx

.section
  margin-bottom 40rpx
  
.section-title
  font-size 32rpx
  font-weight 600
  color #333
  margin-bottom 20rpx
  padding-left 20rpx
  border-left 6rpx solid #f093fb

.api-demo
  .input-group
    margin-bottom 20rpx
    
    .input-field
      width 100%
      padding 25rpx 30rpx
      border 2rpx solid #e9ecef
      border-radius 8rpx
      font-size 28rpx
      box-sizing border-box

  .button-group
    display flex
    flex-wrap wrap
    gap 15rpx
    margin-bottom 20rpx
    
    button
      flex 1
      min-width 120rpx

  .result-box
    background #f8f9fa
    border-radius 8rpx
    padding 25rpx
    margin-top 20rpx
    
    .result-title
      font-size 26rpx
      font-weight 500
      color #333
      margin-bottom 15rpx
      
    .result-content
      font-size 24rpx
      color #666
      line-height 1.6
      word-break break-all

  .info-list
    background #f8f9fa
    border-radius 8rpx
    padding 25rpx
    margin-top 20rpx
    
    .info-item
      display flex
      justify-content space-between
      padding 15rpx 0
      border-bottom 1rpx solid #e9ecef
      
      &:last-child
        border-bottom none
        
      .info-label
        color #666
        font-size 26rpx
        
      .info-value
        color #333
        font-size 26rpx
        font-weight 500
        flex 1
        text-align right
        margin-left 20rpx
        word-break break-all

  .image-preview
    display flex
    flex-wrap wrap
    gap 15rpx
    margin-top 20rpx
    
    .preview-image
      width 150rpx
      height 150rpx
      border-radius 8rpx
      border 2rpx solid #e9ecef

.btn-success
  background #28a745
  color white
  border none
  border-radius 8rpx
  padding 20rpx 30rpx
  font-size 28rpx
  
.btn-warning
  background #ffc107
  color #333
  border none
  border-radius 8rpx
  padding 20rpx 30rpx
  font-size 28rpx
  
.btn-danger
  background #dc3545
  color white
  border none
  border-radius 8rpx
  padding 20rpx 30rpx
  font-size 28rpx
</style>

<script type="application/json">
{
  "usingComponents": {
    "demo-section": "../components/demo-section"
  },
  "navigationBarTitleText": "API æ¼”ç¤º"
}
</script>