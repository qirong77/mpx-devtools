<template>
  <scroll-view class="container" scroll-y="true" style="height: 100vh;">
    <!-- é¡¹ç›®ä»‹ç» -->
    <view class="header card">
      <view class="app-logo">ğŸš€</view>
      <view class="app-name">MPX Demo App</view>
      <view class="app-version">Version {{appInfo.version}}</view>
      <view class="app-desc">è·¨å¹³å°å°ç¨‹åºå¼€å‘æ¡†æ¶ç¤ºä¾‹é¡¹ç›®</view>
    </view>

    <!-- é¡¹ç›®ä¿¡æ¯ -->
    <view class="section">
      <view class="section-title">ğŸ“‹ é¡¹ç›®ä¿¡æ¯</view>
      <info-card 
        wx:for="{{projectInfo}}" 
        wx:key="title"
        title="{{item.title}}"
        content="{{item.content}}"
        icon="{{item.icon}}">
      </info-card>
    </view>

    <!-- ç¯å¢ƒæ£€æµ‹ -->
    <view class="section">
      <view class="section-title">ğŸ” ç¯å¢ƒæ£€æµ‹</view>
      <view class="card">
        <button class="btn-primary full-width" bindtap="detectEnvironment" loading="{{detecting}}">
          {{detecting ? 'æ£€æµ‹ä¸­...' : 'å¼€å§‹ç¯å¢ƒæ£€æµ‹'}}
        </button>
        
        <view class="env-results" wx:if="{{envResults.length > 0}}">
          <view class="env-item" wx:for="{{envResults}}" wx:key="name">
            <view class="env-name">
              <text class="env-icon">{{item.icon}}</text>
              <text class="env-text">{{item.name}}</text>
            </view>
            <view class="env-status {{item.status}}">{{item.value}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- å¹³å°å·®å¼‚å¯¹æ¯” -->
    <view class="section">
      <view class="section-title">âš–ï¸ å¹³å°å·®å¼‚å¯¹æ¯”</view>
      <view class="platform-comparison">
        <platform-card 
          wx:for="{{platforms}}" 
          wx:key="name"
          name="{{item.name}}"
          logo="{{item.logo}}"
          features="{{item.features}}"
          status="{{item.status}}"
          current="{{item.current}}">
        </platform-card>
      </view>
    </view>

    <!-- æŠ€æœ¯æ ˆ -->
    <view class="section">
      <view class="section-title">ğŸ› ï¸ æŠ€æœ¯æ ˆ</view>
      <view class="tech-stack">
        <view class="tech-category" wx:for="{{techStack}}" wx:key="category">
          <view class="tech-title">{{item.category}}</view>
          <view class="tech-list">
            <view class="tech-item" wx:for="{{item.technologies}}" wx:for-item="tech" wx:key="name">
              <text class="tech-name">{{tech.name}}</text>
              <text class="tech-version">{{tech.version}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠŸèƒ½ç‰¹æ€§ -->
    <view class="section">
      <view class="section-title">âœ¨ åŠŸèƒ½ç‰¹æ€§</view>
      <view class="features-grid">
        <view class="feature-item card" wx:for="{{features}}" wx:key="title">
          <view class="feature-icon">{{item.icon}}</view>
          <view class="feature-title">{{item.title}}</view>
          <view class="feature-desc">{{item.description}}</view>
        </view>
      </view>
    </view>

    <!-- å¼€å‘è€…ä¿¡æ¯ -->
    <view class="section">
      <view class="section-title">ğŸ‘¨â€ğŸ’» å¼€å‘è€…ä¿¡æ¯</view>
      <view class="card developer-info">
        <view class="developer-item">
          <text class="label">é¡¹ç›®ä½œè€…ï¼š</text>
          <text class="value">MPX Team</text>
        </view>
        <view class="developer-item">
          <text class="label">GitHubï¼š</text>
          <text class="value link" bindtap="openGitHub">github.com/didi/mpx</text>
        </view>
        <view class="developer-item">
          <text class="label">æ–‡æ¡£åœ°å€ï¼š</text>
          <text class="value link" bindtap="openDocs">mpxjs.cn</text>
        </view>
        <view class="developer-item">
          <text class="label">æ„å»ºæ—¶é—´ï¼š</text>
          <text class="value">{{buildTime}}</text>
        </view>
      </view>
    </view>

    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <view class="section">
      <view class="section-title">ğŸ› è°ƒè¯•ä¿¡æ¯</view>
      <view class="card debug-info">
        <button class="btn-secondary full-width" bindtap="toggleDebugInfo">
          {{showDebugInfo ? 'éšè—' : 'æ˜¾ç¤º'}}è°ƒè¯•ä¿¡æ¯
        </button>
        
        <view class="debug-content" wx:if="{{showDebugInfo}}">
          <view class="debug-item" wx:for="{{debugInfo}}" wx:key="key">
            <text class="debug-key">{{item.key}}ï¼š</text>
            <text class="debug-value">{{item.value}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨ä¿¡æ¯ -->
    <view class="footer">
      <view class="copyright">Â© 2024 MPX Demo App</view>
      <view class="powered-by">Powered by MPX Framework</view>
    </view>
  </scroll-view>
</template>

<script>
import { createPage } from '@mpxjs/core'
import mpx from '@mpxjs/core'

createPage({
  data: {
    appInfo: {
      version: '1.0.0'
    },
    detecting: false,
    showDebugInfo: false,
    buildTime: '',
    
    projectInfo: [
      {
        title: 'MPX æ¡†æ¶',
        content: 'å¢å¼ºå‹è·¨å¹³å°å°ç¨‹åºæ¡†æ¶ï¼Œæ·±åº¦æ€§èƒ½ä¼˜åŒ–ï¼Œæ”¯æŒè·¨å¹³å°',
        icon: 'ğŸ¯'
      },
      {
        title: 'è·¨å¹³å°æ”¯æŒ',
        content: 'å¾®ä¿¡ã€æ”¯ä»˜å®ã€ç™¾åº¦ã€å­—èŠ‚è·³åŠ¨ã€QQå°ç¨‹åºåŠH5',
        icon: 'ğŸŒ'
      },
      {
        title: 'å¼€å‘ä½“éªŒ',
        content: 'Vue.jsè¯­æ³•æ”¯æŒï¼Œå®Œå–„çš„TypeScriptæ”¯æŒ',
        icon: 'ğŸ’¡'
      },
      {
        title: 'æ€§èƒ½ä¼˜åŒ–',
        content: 'ç¼–è¯‘æ—¶ä¼˜åŒ–ã€è¿è¡Œæ—¶ä¼˜åŒ–ã€åŒ…ä½“ç§¯ä¼˜åŒ–',
        icon: 'âš¡'
      }
    ],

    platforms: [
      {
        name: 'å¾®ä¿¡å°ç¨‹åº',
        logo: 'ğŸŸ¢',
        features: ['åŸç”Ÿæ€§èƒ½', 'ä¸°å¯ŒAPI', 'æœ€å¤§ç”¨æˆ·ç¾¤ä½“'],
        status: 'supported',
        current: true
      },
      {
        name: 'æ”¯ä»˜å®å°ç¨‹åº',
        logo: 'ğŸ”µ',
        features: ['é‡‘èåœºæ™¯', 'ä¼ä¸šæœåŠ¡', 'IoTæ”¯æŒ'],
        status: 'supported',
        current: false
      },
      {
        name: 'ç™¾åº¦å°ç¨‹åº',
        logo: 'ğŸ”´',
        features: ['AIèƒ½åŠ›', 'æœç´¢å…¥å£', 'æ™ºèƒ½æ¨è'],
        status: 'supported',
        current: false
      },
      {
        name: 'å­—èŠ‚è·³åŠ¨',
        logo: 'âš«',
        features: ['å¹´è½»ç”¨æˆ·', 'åˆ›æ–°åŠŸèƒ½', 'çŸ­è§†é¢‘ç”Ÿæ€'],
        status: 'supported',
        current: false
      }
    ],

    techStack: [
      {
        category: 'æ ¸å¿ƒæ¡†æ¶',
        technologies: [
          { name: '@mpxjs/core', version: '2.10.0' },
          { name: 'Vue.js', version: '2.7.0' },
          { name: '@mpxjs/api-proxy', version: '2.10.0' }
        ]
      },
      {
        category: 'æ„å»ºå·¥å…·',
        technologies: [
          { name: '@mpxjs/webpack-plugin', version: '2.10.0' },
          { name: 'Webpack', version: '5.43.0' },
          { name: 'Babel', version: '7.10.4' }
        ]
      },
      {
        category: 'å¼€å‘å·¥å…·',
        technologies: [
          { name: '@vue/cli-service', version: '5.0.0' },
          { name: 'Stylus', version: '0.55.0' },
          { name: 'PostCSS', version: '8.2.6' }
        ]
      }
    ],

    features: [
      {
        title: 'è·¨å¹³å°ç¼–è¯‘',
        description: 'ä¸€å¥—ä»£ç ç¼–è¯‘åˆ°å¤šä¸ªå°ç¨‹åºå¹³å°',
        icon: 'ğŸ”„'
      },
      {
        title: 'æ€§èƒ½ä¼˜åŒ–',
        description: 'ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶çš„æ·±åº¦ä¼˜åŒ–',
        icon: 'ğŸš€'
      },
      {
        title: 'TypeScript',
        description: 'å®Œæ•´çš„TypeScriptå¼€å‘æ”¯æŒ',
        icon: 'ğŸ“'
      },
      {
        title: 'ç»„ä»¶åŒ–',
        description: 'æ”¯æŒVueé£æ ¼çš„ç»„ä»¶åŒ–å¼€å‘',
        icon: 'ğŸ§©'
      },
      {
        title: 'çŠ¶æ€ç®¡ç†',
        description: 'å†…ç½®PiniaçŠ¶æ€ç®¡ç†æ”¯æŒ',
        icon: 'ğŸ“¦'
      },
      {
        title: 'å·¥å…·é“¾',
        description: 'å®Œå–„çš„å¼€å‘å’Œè°ƒè¯•å·¥å…·é“¾',
        icon: 'ğŸ› ï¸'
      }
    ],

    envResults: [],
    debugInfo: []
  },

  onLoad() {
    this.initializePage()
  },

  methods: {
    initializePage() {
      // è®¾ç½®æ„å»ºæ—¶é—´
      this.buildTime = new Date().toLocaleString('zh-CN')
      
      // æ£€æµ‹å½“å‰å¹³å°
      this.detectCurrentPlatform()
    },

    detectCurrentPlatform() {
      mpx.getSystemInfo({
        success: (res) => {
          // æ›´æ–°å¹³å°ä¿¡æ¯
          this.platforms = this.platforms.map(platform => ({
            ...platform,
            current: platform.name.includes('å¾®ä¿¡') && res.platform
          }))
        }
      })
    },

    async detectEnvironment() {
      this.detecting = true
      this.envResults = []

      try {
        // æ¨¡æ‹Ÿæ£€æµ‹è¿‡ç¨‹
        await this.sleep(500)

        // ç³»ç»Ÿä¿¡æ¯æ£€æµ‹
        const systemInfo = await this.getSystemInfoAsync()
        this.envResults.push({
          name: 'ç³»ç»Ÿå¹³å°',
          value: systemInfo.platform || 'æœªçŸ¥',
          status: 'success',
          icon: 'ğŸ“±'
        })

        await this.sleep(300)

        // ç½‘ç»œçŠ¶æ€æ£€æµ‹
        const networkInfo = await this.getNetworkInfoAsync()
        this.envResults.push({
          name: 'ç½‘ç»œçŠ¶æ€',
          value: networkInfo.networkType || 'æœªçŸ¥',
          status: networkInfo.networkType !== 'none' ? 'success' : 'error',
          icon: 'ğŸŒ'
        })

        await this.sleep(300)

        // å­˜å‚¨åŠŸèƒ½æ£€æµ‹
        const storageSupported = this.testStorageSupport()
        this.envResults.push({
          name: 'æœ¬åœ°å­˜å‚¨',
          value: storageSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ',
          status: storageSupported ? 'success' : 'error',
          icon: 'ğŸ’¾'
        })

        await this.sleep(300)

        // API æ”¯æŒæ£€æµ‹
        const apiSupport = this.testAPISupport()
        this.envResults.push({
          name: 'API æ”¯æŒ',
          value: `${apiSupport.supported}/${apiSupport.total}`,
          status: apiSupport.supported > apiSupport.total * 0.8 ? 'success' : 'warning',
          icon: 'ğŸ”§'
        })

        mpx.showToast({
          title: 'ç¯å¢ƒæ£€æµ‹å®Œæˆ',
          icon: 'success'
        })

      } catch (error) {
        mpx.showToast({
          title: 'æ£€æµ‹å¤±è´¥',
          icon: 'error'
        })
      } finally {
        this.detecting = false
      }
    },

    toggleDebugInfo() {
      this.showDebugInfo = !this.showDebugInfo
      
      if (this.showDebugInfo && this.debugInfo.length === 0) {
        this.generateDebugInfo()
      }
    },

    generateDebugInfo() {
      mpx.getSystemInfo({
        success: (res) => {
          this.debugInfo = [
            { key: 'appId', value: res.appId || 'N/A' },
            { key: 'platform', value: res.platform },
            { key: 'system', value: res.system },
            { key: 'version', value: res.version },
            { key: 'SDKVersion', value: res.SDKVersion },
            { key: 'screenWidth', value: `${res.screenWidth}px` },
            { key: 'screenHeight', value: `${res.screenHeight}px` },
            { key: 'windowWidth', value: `${res.windowWidth}px` },
            { key: 'windowHeight', value: `${res.windowHeight}px` },
            { key: 'pixelRatio', value: res.pixelRatio },
            { key: 'statusBarHeight', value: `${res.statusBarHeight}px` },
            { key: 'language', value: res.language },
            { key: 'fontSizeSetting', value: res.fontSizeSetting }
          ]
        }
      })
    },

    // è¾…åŠ©æ–¹æ³•
    sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms))
    },

    getSystemInfoAsync() {
      return new Promise((resolve) => {
        mpx.getSystemInfo({
          success: resolve,
          fail: () => resolve({})
        })
      })
    },

    getNetworkInfoAsync() {
      return new Promise((resolve) => {
        mpx.getNetworkType({
          success: resolve,
          fail: () => resolve({})
        })
      })
    },

    testStorageSupport() {
      try {
        mpx.setStorageSync('test', 'test')
        mpx.removeStorageSync('test')
        return true
      } catch (e) {
        return false
      }
    },

    testAPISupport() {
      const apis = [
        'getSystemInfo', 'showToast', 'showModal', 'navigateTo',
        'request', 'getStorage', 'setStorage', 'getLocation',
        'chooseImage', 'previewImage', 'scanCode', 'vibrateShort'
      ]
      
      let supported = 0
      apis.forEach(api => {
        if (mpx[api]) {
          supported++
        }
      })
      
      return { supported, total: apis.length }
    },

    // å¤–éƒ¨é“¾æ¥
    openGitHub() {
      mpx.setClipboardData({
        data: 'https://github.com/didi/mpx',
        success: () => {
          mpx.showToast({
            title: 'é“¾æ¥å·²å¤åˆ¶',
            icon: 'success'
          })
        }
      })
    },

    openDocs() {
      mpx.setClipboardData({
        data: 'https://mpxjs.cn',
        success: () => {
          mpx.showToast({
            title: 'é“¾æ¥å·²å¤åˆ¶',
            icon: 'success'
          })
        }
      })
    }
  }
})
</script>

<style lang="stylus">
.container
  padding 0 20rpx 40rpx
  
.header
  text-align center
  background linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)
  color white
  
  .app-logo
    font-size 80rpx
    margin-bottom 20rpx
    
  .app-name
    font-size 40rpx
    font-weight 600
    color white
    margin-bottom 10rpx
    
  .app-version
    font-size 24rpx
    color rgba(255, 255, 255, 0.8)
    margin-bottom 15rpx
    
  .app-desc
    font-size 26rpx
    color rgba(255, 255, 255, 0.9)
    line-height 1.5

.section
  margin-bottom 40rpx
  
.section-title
  font-size 32rpx
  font-weight 600
  color #333
  margin-bottom 20rpx
  padding-left 20rpx
  border-left 6rpx solid #4facfe

.full-width
  width 100%
  margin-bottom 20rpx

.env-results
  margin-top 20rpx
  
  .env-item
    display flex
    justify-content space-between
    align-items center
    padding 20rpx 0
    border-bottom 1rpx solid #f0f0f0
    
    &:last-child
      border-bottom none
      
    .env-name
      display flex
      align-items center
      
      .env-icon
        font-size 24rpx
        margin-right 15rpx
        
      .env-text
        font-size 28rpx
        color #333
        
    .env-status
      font-size 26rpx
      padding 8rpx 16rpx
      border-radius 20rpx
      
      &.success
        background #d4edda
        color #155724
        
      &.warning
        background #fff3cd
        color #856404
        
      &.error
        background #f8d7da
        color #721c24

.platform-comparison
  display grid
  grid-template-columns repeat(auto-fit, minmax(300rpx, 1fr))
  gap 20rpx

.tech-stack
  .tech-category
    margin-bottom 30rpx
    
    .tech-title
      font-size 28rpx
      font-weight 500
      color #333
      margin-bottom 15rpx
      padding 15rpx 20rpx
      background #f8f9fa
      border-radius 8rpx
      
    .tech-list
      .tech-item
        display flex
        justify-content space-between
        align-items center
        padding 20rpx
        border-bottom 1rpx solid #f0f0f0
        
        &:last-child
          border-bottom none
          
        .tech-name
          font-size 26rpx
          color #333
          
        .tech-version
          font-size 24rpx
          color #666
          padding 6rpx 12rpx
          background #e9ecef
          border-radius 12rpx

.features-grid
  display grid
  grid-template-columns repeat(auto-fit, minmax(280rpx, 1fr))
  gap 20rpx
  
  .feature-item
    text-align center
    
    .feature-icon
      font-size 50rpx
      margin-bottom 15rpx
      
    .feature-title
      font-size 28rpx
      font-weight 500
      color #333
      margin-bottom 10rpx
      
    .feature-desc
      font-size 24rpx
      color #666
      line-height 1.5

.developer-info
  .developer-item
    display flex
    justify-content space-between
    align-items center
    padding 20rpx 0
    border-bottom 1rpx solid #f0f0f0
    
    &:last-child
      border-bottom none
      
    .label
      font-size 26rpx
      color #666
      
    .value
      font-size 26rpx
      color #333
      
      &.link
        color #667eea
        text-decoration underline

.debug-info
  .debug-content
    margin-top 20rpx
    background #f8f9fa
    border-radius 8rpx
    padding 25rpx
    
    .debug-item
      display flex
      margin-bottom 15rpx
      
      &:last-child
        margin-bottom 0
        
      .debug-key
        font-size 24rpx
        color #666
        min-width 200rpx
        
      .debug-value
        font-size 24rpx
        color #333
        word-break break-all
        flex 1

.footer
  text-align center
  padding 40rpx 0
  color #999
  
  .copyright
    font-size 24rpx
    margin-bottom 10rpx
    
  .powered-by
    font-size 22rpx
</style>

<script type="application/json">
{
  "usingComponents": {
    "info-card": "../components/info-card",
    "platform-card": "../components/platform-card"
  },
  "navigationBarTitleText": "å…³äº"
}
</script>